{% extends 'main.html' %}
{% load static %}

{% block content %}

<style>
    .rulebook-container {
        min-height: 80vh;
        padding: 40px 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .rulebook-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        padding: 30px;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .rulebook-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 3px solid #667eea;
    }
    
    .rulebook-header h1 {
        color: #333;
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
    }
    
    .rulebook-header p {
        color: #666;
        font-size: 1.1rem;
    }
    
    .flipbook-container {
        position: relative;
        width: 100%;
        height: 700px;
        background: #f5f5f5;
        border-radius: 10px;
        overflow: hidden;
    }
    
    #pdf-canvas {
        width: 100%;
        height: 100%;
    }
    
    .flipbook-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
    }
    
    .page-info {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
    }
    
    .btn-flip {
        padding: 12px 30px;
        font-size: 1.1rem;
        border-radius: 8px;
        transition: all 0.3s;
    }
    
    .btn-flip:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 700px;
    }
    
    .no-rulebook {
        text-align: center;
        padding: 60px 20px;
    }
    
    .no-rulebook i {
        font-size: 5rem;
        color: #ccc;
        margin-bottom: 20px;
    }
    
    .fullscreen-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 100;
    }
</style>

<div class="rulebook-container">
    <div class="rulebook-card">
        <div class="rulebook-header">
            <h1><i class="bi bi-book-fill"></i> ADAMS Rulebook</h1>
            <p id="rulebookDescription">Official Rulebook - Members Only</p>
        </div>
        
        <div class="flipbook-container" id="flipbookContainer">
            <button class="btn btn-primary fullscreen-btn" onclick="toggleFullscreen()">
                <i class="bi bi-fullscreen"></i>
            </button>
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <canvas id="pdf-canvas" style="display: none;"></canvas>
            <div class="no-rulebook" id="noRulebook" style="display: none;">
                <i class="bi bi-file-earmark-x"></i>
                <h3>No Rulebook Available</h3>
                <p>The rulebook is currently not available. Please contact admin.</p>
            </div>
        </div>
        
        <div class="flipbook-controls" id="flipbookControls" style="display: none;">
            <button class="btn btn-secondary btn-flip" id="prevBtn" onclick="prevPage()">
                <i class="bi bi-arrow-left"></i> Previous
            </button>
            <div class="page-info">
                Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
            </div>
            <button class="btn btn-secondary btn-flip" id="nextBtn" onclick="nextPage()">
                Next <i class="bi bi-arrow-right"></i>
            </button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    let pdfDoc = null;
    let pageNum = 1;
    let pageRendering = false;
    let pageNumPending = null;
    const scale = 1.5;
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    
    async function loadRulebook() {
        try {
            const response = await fetch('/api/get-active-rulebook/');
            const data = await response.json();
            
            if (data.success && data.rulebook) {
                document.getElementById('rulebookDescription').textContent = data.rulebook.description || 'Official Rulebook - Members Only';
                
                // Load PDF
                const loadingTask = pdfjsLib.getDocument(data.rulebook.pdf_url);
                pdfDoc = await loadingTask.promise;
                document.getElementById('totalPages').textContent = pdfDoc.numPages;
                
                // Hide loading, show canvas and controls
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('pdf-canvas').style.display = 'block';
                document.getElementById('flipbookControls').style.display = 'flex';
                
                // Render first page
                renderPage(pageNum);
            } else {
                // No rulebook available
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('noRulebook').style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading rulebook:', error);
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('noRulebook').style.display = 'block';
        }
    }
    
    function renderPage(num) {
        pageRendering = true;
        
        pdfDoc.getPage(num).then(function(page) {
            const viewport = page.getViewport({scale: scale});
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            
            const renderTask = page.render(renderContext);
            
            renderTask.promise.then(function() {
                pageRendering = false;
                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }
            });
        });
        
        document.getElementById('currentPage').textContent = num;
    }
    
    function queueRenderPage(num) {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    }
    
    function prevPage() {
        if (pageNum <= 1) {
            return;
        }
        pageNum--;
        queueRenderPage(pageNum);
    }
    
    function nextPage() {
        if (pageNum >= pdfDoc.numPages) {
            return;
        }
        pageNum++;
        queueRenderPage(pageNum);
    }
    
    function toggleFullscreen() {
        const container = document.getElementById('flipbookContainer');
        if (!document.fullscreenElement) {
            container.requestFullscreen().catch(err => {
                alert(`Error attempting to enable fullscreen: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    }
    
    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowLeft') {
            prevPage();
        } else if (e.key === 'ArrowRight') {
            nextPage();
        }
    });
    
    // Load rulebook when page loads
    loadRulebook();
</script>

{% endblock content %}

